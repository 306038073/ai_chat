<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIÊô∫ËÅäÁ≥ªÁªü</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root {
            --primary: #1890ff;
            --dark-bg: #1f2d3d;
            --light-bg: #f0f2f5;
            --border: #dcdfe6;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif;
            background-color: var(--light-bg);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        /* ‰æßËæπÊ†èÊ†∑Âºè */
        .sidebar {
            width: 260px;
            background-color: white;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 10;
        }
        
        .new-chat-btn {
            margin: 16px;
            padding: 10px 16px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .new-chat-btn:hover {
            background-color: #40a9ff;
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        
        .chat-item {
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 6px;
            transition: background-color 0.2s;
        }
        
        .chat-item:hover, .chat-item.active {
            background-color: #e6f7ff;
        }
        
        .user-info {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        
        /* ‰∏ªËÅäÂ§©Âå∫Âüü */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            font-size: 18px;
            font-weight: 500;
        }
        
        .message-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background-color: white;
        }
        
        .message {
            margin-bottom: 16px;
            max-width: 80%;
        }
        
        .user-message {
            margin-left: auto;
            background-color: #e6f7ff;
            padding: 10px 16px;
            border-radius: 18px 18px 0 18px;
        }
        
        .ai-message {
            margin-right: auto;
            background-color: #f0f2f5;
            padding: 10px 16px;
            border-radius: 18px 18px 18px 0;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }
        
        .input-area {
            padding: 16px;
            background-color: white;
            border-top: 1px solid var(--border);
            display: flex;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 20px;
            outline: none;
            font-size: 16px;
        }
        
        .send-btn {
            margin-left: 12px;
            padding: 12px 24px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .send-btn:hover {
            background-color: #40a9ff;
        }
        
        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
            .message {
                max-width: 90%;
            }
        }
        
        /* ÁôªÂΩïÂºπÁ™óÊ†∑Âºè */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .login-form {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 350px;
        }
        
        .login-form h2 {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .loading-indicator {
            display: inline-block;
            margin-left: 10px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ÁôªÂΩïÂºπÁ™ó -->
        <div v-if="!isLoggedIn" class="login-modal">
            <div class="login-form">
                <h2>ÁôªÂΩïAIËÅäÂ§©Á≥ªÁªü</h2>
                <div class="form-group">
                    <label>Áî®Êà∑Âêç</label>
                    <input v-model="loginForm.username" type="text" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç">
                </div>
                <div class="form-group">
                    <label>ÂØÜÁ†Å</label>
                    <input v-model="loginForm.password" type="password" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å">
                </div>
                <button @click="login" class="login-btn">ÁôªÂΩï</button>
            </div>
        </div>

        <div class="app-container" v-if="isLoggedIn">
            <div class="sidebar">
                <button class="new-chat-btn" @click="newConversation">+ Êñ∞Âª∫ÂØπËØù</button>
                <div class="chat-history">
                    <div v-for="(conv, index) in conversations" 
                         :key="index"
                         :class="['chat-item', currentConversationId === conv.id ? 'active' : '']"
                         @click="switchConversation(conv.id)">
                        {{ conv.title }}
                    </div>
                </div>
                <div class="user-info">
                    <div class="avatar">üë§</div>
                    <div>{{ username }}</div>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-header">
                    {{ getConversationTitle() }}
                </div>
                
                <div class="message-list">
                    <div v-for="(message, index) in messages" :key="index" class="message">
                        <div :class="message.role === 'user' ? 'user-message' : 'ai-message'">
                            {{ message.content }}
                            <span v-if="message.isLoading" class="loading-indicator">ÊÄùËÄÉ‰∏≠...</span>
                        </div>
                    </div>
                </div>
                
                <div class="input-area">
                    <input 
                        class="message-input" 
                        v-model="inputText" 
                        placeholder="ËæìÂÖ•Ê∂àÊÅØ..." 
                        @keyup.enter="sendMessage" 
                        :disabled="isSending"
                    />
                    <button 
                        class="send-btn" 
                        @click="sendMessage"
                        :disabled="isSending || !inputText.trim()"
                    >
                        ÂèëÈÄÅ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        
        createApp({
            setup() {
                // Áî®Êà∑Êï∞ÊçÆ
                const username = ref('ÊµãËØïÁî®Êà∑');
                const isLoggedIn = ref(false);
                const loginForm = ref({
                    username: '',
                    password: ''
                });
                
                // ÂØπËØùÊï∞ÊçÆ
                const conversations = ref([]);
                const currentConversationId = ref(null);
                
                // Ê∂àÊÅØÊï∞ÊçÆ
                const messages = ref([]);
                const inputText = ref('');
                const isSending = ref(false);
                
                // APIËøûÊé•ÁÇπ
                const api = {
                    // ‰øùÂ≠òÊ∂àÊÅØÂà∞Êï∞ÊçÆÂ∫ì
                    saveMessageToDB: async (message) => {
                        try {
                            const response = await axios.post('http://localhost:8080/api/messages', {
                                conversationId: currentConversationId.value,
                                role: message.role,
                                content: message.content
                            });
                            
                            console.log("Ê∂àÊÅØ‰øùÂ≠òÊàêÂäü:", response.data);
                            return response.data;
                        } catch (error) {
                            console.error("Ê∂àÊÅØ‰øùÂ≠òÂ§±Ë¥•:", error);
                            // ÈîôËØØÂ§ÑÁêÜÔºöÊòæÁ§∫Áî®Êà∑ÊèêÁ§∫
                            messages.value.push({
                                id: Date.now(),
                                role: 'system',
                                content: '‚ö†Ô∏è Ê∂àÊÅØ‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•'
                            });
                        }
                    },
                    
                    // Âä†ËΩΩÂØπËØùÂéÜÂè≤
                    loadConversationHistory: async (conversationId) => {
                        try {
                            const response = await axios.get(`http://localhost:8080/api/messages?conversationId=${conversationId}`);
                            return response.data.map(msg => ({
                                id: msg.id,
                                role: msg.role,
                                content: msg.content,
                                createdAt: msg.createdAt
                            }));
                        } catch (error) {
                            console.error("Âä†ËΩΩÂéÜÂè≤Ê∂àÊÅØÂ§±Ë¥•:", error);
                            return [];
                        }
                    },
                    
                    // ËÖæËÆØÊ∑∑ÂÖÉAPIË∞ÉÁî®
                    callTencentHunyuan: async (userInput) => {
                        try {
                            // ÂÆûÈôÖË∞ÉÁî®ËÖæËÆØÊ∑∑ÂÖÉAPI
                            const response = await axios.post(
                                'https://api.tencent.com/hunyuan/chat', 
                                {
                                    appId: 'YOUR_APP_ID',
                                    secretId: 'YOUR_SECRET_ID',
                                    sessionId: currentConversationId.value,
                                    messages: [{
                                        role: 'user', 
                                        content: userInput
                                    }]
                                },
                                {
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                                    }
                                }
                            );
                            
                            return response.data;
                        } catch (error) {
                            console.error("ËÖæËÆØÊ∑∑ÂÖÉAPIË∞ÉÁî®Â§±Ë¥•:", error);
                            throw error;
                        }
                    }
                };
                
                // Ê†∏ÂøÉ‰∏öÂä°ÂáΩÊï∞
                const getConversationTitle = () => {
                    const conv = conversations.value.find(c => c.id === currentConversationId.value);
                    return conv ? conv.title : 'Êñ∞ÂØπËØù';
                };
                
                // Êñ∞Âª∫ÂØπËØù
                const newConversation = async () => {
                    try {
                        // Ë∞ÉÁî®ÂêéÁ´ØAPIÂàõÂª∫Êñ∞ÂØπËØù
                        const response = await axios.post('http://localhost:8080/api/conversations', {
                            userId: 1, // ÂÆûÈôÖÈ°πÁõÆ‰∏≠‰ªéÁôªÂΩï‰ø°ÊÅØËé∑Âèñ
                            title: `Êñ∞ÂØπËØù ${conversations.value.length + 1}`
                        });
                        
                        const newConv = response.data;
                        conversations.value.push(newConv);
                        currentConversationId.value = newConv.id;
                        
                        messages.value = [
                            { 
                                id: Date.now(), 
                                role: 'ai', 
                                content: 'ËøôÊòØÊñ∞ÁöÑÂØπËØùÔºÅËØ∑ÈóÆÊúâ‰ªÄ‰πàÂèØ‰ª•Â∏ÆÊÇ®ÁöÑÔºü' 
                            }
                        ];
                    } catch (error) {
                        console.error("ÂàõÂª∫ÂØπËØùÂ§±Ë¥•:", error);
                        messages.value.push({
                            id: Date.now(),
                            role: 'system',
                            content: '‚ö†Ô∏è ÂàõÂª∫Êñ∞ÂØπËØùÂ§±Ë¥•ÔºåËØ∑ÈáçËØï'
                        });
                    }
                };
                
                // ÂàáÊç¢ÂØπËØù
                const switchConversation = (id) => {
                    currentConversationId.value = id;
                    api.loadConversationHistory(id).then(history => {
                        if (history.length) {
                            messages.value = history;
                        } else {
                            messages.value = [
                                { id: Date.now(), role: 'ai', content: 'Â∑≤ÂàáÊç¢Âà∞Êú¨ÂØπËØù' }
                            ];
                        }
                    });
                };
                
                // ÂèëÈÄÅÊ∂àÊÅØ
                const sendMessage = async () => {
                    if (!inputText.value.trim() || isSending.value) return;
                    
                    isSending.value = true;
                    
                    // 1. ÂàõÂª∫Áî®Êà∑Ê∂àÊÅØÂØπË±°
                    const userMessage = {
                        id: Date.now(),
                        role: 'user',
                        content: inputText.value
                    };
                    
                    // 2. Ê∑ªÂä†Âà∞ÂΩìÂâçÊ∂àÊÅØÂàóË°®
                    messages.value.push(userMessage);
                    inputText.value = '';
                    
                    // 3. ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                    const loadingMsg = {
                        id: Date.now() + 1,
                        role: 'ai',
                        content: '',
                        isLoading: true
                    };
                    messages.value.push(loadingMsg);
                    
                    try {
                        // 4. ‰øùÂ≠òÁî®Êà∑Ê∂àÊÅØÂà∞Êï∞ÊçÆÂ∫ì
                        await api.saveMessageToDB(userMessage);
                        
                        // 5. Ë∞ÉÁî®ËÖæËÆØÊ∑∑ÂÖÉAPIËé∑ÂèñAIÂõûÂ§ç
                        const response = await api.callTencentHunyuan(userMessage.content);
                        
                        // 6. Ëé∑ÂèñAIÂõûÂ§çÂÜÖÂÆπ
                        const aiResponse = response.choices[0].message.content;
                        
                        // 7. ÂàõÂª∫AIÊ∂àÊÅØÂØπË±°
                        const aiMessage = {
                            id: Date.now() + 2,
                            role: 'ai',
                            content: aiResponse
                        };
                        
                        // 8. ‰øùÂ≠òAIÊ∂àÊÅØÂà∞Êï∞ÊçÆÂ∫ì
                        await api.saveMessageToDB(aiMessage);
                        
                        // 9. ÊõøÊç¢Âä†ËΩΩÊ∂àÊÅØ‰∏∫ÂÆûÈôÖÂõûÂ§ç
                        messages.value = messages.value.filter(msg => msg.id !== loadingMsg.id);
                        messages.value.push(aiMessage);
                        
                    } catch (error) {
                        console.error("Ê∂àÊÅØÂ§ÑÁêÜÂ§±Ë¥•:", error);
                        
                        // 10. ÈîôËØØÂ§ÑÁêÜ
                        const errorMsg = {
                            id: Date.now() + 3,
                            role: 'ai',
                            content: 'Êä±Ê≠âÔºåAIÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®ÔºåËØ∑Á®çÂêéÂÜçËØï'
                        };
                        
                        messages.value = messages.value.filter(msg => msg.id !== loadingMsg.id);
                        messages.value.push(errorMsg);
                    } finally {
                        isSending.value = false;
                    }
                };
                
                // ÁôªÂΩïÊñπÊ≥ï
                const login = async () => {






    // Ê∑ªÂä†ÊµãËØïË¥¶Âè∑ÔºàÂºÄÂèëÈò∂ÊÆµ‰ΩøÁî®Ôºâ
    if (loginForm.value.username === 'admin' && loginForm.value.password === '123') {
        isLoggedIn.value = true;
        username.value = loginForm.value.username;
        
        // Ê®°ÊãüÁî®Êà∑ÂØπËØùÊï∞ÊçÆ
        conversations.value = [
            { id: 'test-conv-1', title: 'ÊµãËØïÂØπËØù 1' },
            { id: 'test-conv-2', title: 'ÊµãËØïÂØπËØù 2' }
        ];
        
        currentConversationId.value = 'test-conv-1';
        messages.value = [
            { id: Date.now(), role: 'ai', content: 'ËøôÊòØÊµãËØïË¥¶Âè∑ÁöÑÊ®°ÊãüÂØπËØùÔºåÊó†ÈúÄÁúüÂÆûAPIËøûÊé•' }
       ];
        
        return; // Ë∑≥ËøáÂÆûÈôÖAPIËØ∑Ê±Ç
    }
    
    // ÂéüÊúâÁöÑÁôªÂΩï‰ª£Á†Å...





                    try {
                        const response = await axios.post('http://localhost:8080/api/login', loginForm.value);
                        const token = response.data.token;
                        
                        // Â≠òÂÇ®token
                        localStorage.setItem('authToken', token);
                        
                        // ËÆæÁΩÆaxiosÈªòËÆ§ËØ∑Ê±ÇÂ§¥
                        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                        
                        // Êõ¥Êñ∞ÁôªÂΩïÁä∂ÊÄÅ
                        isLoggedIn.value = true;
                        username.value = loginForm.value.username;
                        
                        // Âä†ËΩΩÁî®Êà∑ÂØπËØù
                        await loadUserConversations();
                    } catch (error) {
                        console.error("ÁôªÂΩïÂ§±Ë¥•:", error);
                        alert('ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å');
                    }
                };
                
                // Âä†ËΩΩÁî®Êà∑ÂØπËØù
                const loadUserConversations = async () => {
                    try {
                        const response = await axios.get('http://localhost:8080/api/conversations');
                        conversations.value = response.data;
                        
                        if (conversations.value.length > 0) {
                            currentConversationId.value = conversations.value[0].id;
                            // Âä†ËΩΩÁ¨¨‰∏ÄÊù°ÂØπËØùÁöÑÂéÜÂè≤Ê∂àÊÅØ
                            const history = await api.loadConversationHistory(currentConversationId.value);
                            messages.value = history;
                        }
                    } catch (error) {
                        console.error("Âä†ËΩΩÂØπËØùÂàóË°®Â§±Ë¥•:", error);
                    }
                };
                
                // ÂÖ®Â±ÄaxiosÈîôËØØÂ§ÑÁêÜ
                axios.interceptors.response.use(
                    response => response,
                    error => {
                        if (error.response) {
                            // 401Êú™ÊéàÊùÉÈîôËØØÂ§ÑÁêÜ
                            if (error.response.status === 401) {
                                localStorage.removeItem('authToken');
                                isLoggedIn.value = false;
                                alert('‰ºöËØùÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                            }
                            // ÂÖ∂‰ªñÈîôËØØÂ§ÑÁêÜ
                            else {
                                console.error('APIÈîôËØØ:', error.response.data);
                            }
                        } else {
                            console.error('ÁΩëÁªúÈîôËØØ:', error.message);
                        }
                        return Promise.reject(error);
                    }
                );
                
                onMounted(async () => {
                    // Ê£ÄÊü•Êú¨Âú∞ÊòØÂê¶Êúâtoken
                    const token = localStorage.getItem('authToken');
                    if (token) {
                        // ËÆæÁΩÆaxiosÈªòËÆ§ËØ∑Ê±ÇÂ§¥
                        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                        
                        try {
                            // È™åËØÅtokenÊúâÊïàÊÄß
                            await axios.get('http://localhost:8080/api/validate-token');
                            
                            // Êõ¥Êñ∞ÁôªÂΩïÁä∂ÊÄÅ
                            isLoggedIn.value = true;
                            
                            // Ëé∑ÂèñÁî®Êà∑Âêç
                            const userResponse = await axios.get('http://localhost:8080/api/user');
                            username.value = userResponse.data.username;
                            
                            // Âä†ËΩΩÁî®Êà∑ÂØπËØù
                            await loadUserConversations();
                            
                        } catch (error) {
                            console.error("TokenÈ™åËØÅÂ§±Ë¥•:", error);
                            localStorage.removeItem('authToken');
                        }
                    }
                });
                
                return {
                    username,
                    isLoggedIn,
                    loginForm,
                    conversations,
                    currentConversationId,
                    messages,
                    inputText,
                    isSending,
                    getConversationTitle,
                    newConversation,
                    switchConversation,
                    sendMessage,
                    login
                };
            }
        }).mount('#app');
    </script>
</body>
</html>